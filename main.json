{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "8581014782539082663"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources. Defaults to the resource group location."
      }
    },
    "hubVnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/16",
      "metadata": {
        "description": "Address block for the Hub VNet. This should not overlap with Spoke VNets."
      }
    }
  },
  "variables": {
    "hubVnetName": "vnet-hub"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-hub-vnet",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetName": {
            "value": "[variables('hubVnetName')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('hubVnetPrefix')]"
          },
          "subnets": {
            "value": [
              {
                "name": "GatewaySubnet",
                "addressPrefix": "10.0.1.0/24"
              },
              {
                "name": "AzureFirewallSubnet",
                "addressPrefix": "10.0.2.0/24"
              },
              {
                "name": "ManagementSubnet",
                "addressPrefix": "10.0.3.0/24"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13426536082374555844"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Virtual Network."
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Address space for the Virtual Network."
              }
            },
            "subnets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "List of subnets to create."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for the resources, e.g. CostCenter, Env."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-04-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "copy": [
                  {
                    "name": "subnets",
                    "count": "[length(parameters('subnets'))]",
                    "input": {
                      "name": "[parameters('subnets')[copyIndex('subnets')].name]",
                      "properties": {
                        "addressPrefix": "[parameters('subnets')[copyIndex('subnets')].addressPrefix]",
                        "networkSecurityGroup": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'nsgId'), createObject('id', parameters('subnets')[copyIndex('subnets')].nsgId), null())]",
                        "routeTable": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'routeTableId'), createObject('id', parameters('subnets')[copyIndex('subnets')].routeTableId), null())]",
                        "privateEndpointNetworkPolicies": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'privateEndpointNetworkPolicies'), parameters('subnets')[copyIndex('subnets')].privateEndpointNetworkPolicies, 'Enabled')]",
                        "privateLinkServiceNetworkPolicies": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'privateLinkServiceNetworkPolicies'), parameters('subnets')[copyIndex('subnets')].privateLinkServiceNetworkPolicies, 'Enabled')]"
                      }
                    }
                  }
                ],
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                }
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[parameters('vnetName')]"
            },
            "subnets": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('subnets'))]",
                "input": {
                  "name": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[copyIndex()].name]",
                  "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[copyIndex()].id]",
                  "addressPrefix": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[copyIndex()].properties.addressPrefix]"
                }
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-firewall",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "firewallName": {
            "value": "fw-hub"
          },
          "firewallSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet'), '2025-04-01').outputs.subnets.value[1].id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3490240620740414193"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "firewallName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Firewall."
              }
            },
            "firewallSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the AzureFirewallSubnet. Must be named exactly \"AzureFirewallSubnet\"."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-04-01",
              "name": "[format('pip-{0}', parameters('firewallName'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/firewallPolicies",
              "apiVersion": "2023-04-01",
              "name": "[format('policy-{0}', parameters('firewallName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "threatIntelMode": "Alert"
              }
            },
            {
              "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', format('policy-{0}', parameters('firewallName')), 'DefaultNetworkRuleCollectionGroup')]",
              "properties": {
                "priority": 100,
                "ruleCollections": [
                  {
                    "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                    "action": {
                      "type": "Allow"
                    },
                    "name": "AllowAll",
                    "priority": 100,
                    "rules": [
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowAllTraffic",
                        "ipProtocols": [
                          "Any"
                        ],
                        "sourceAddresses": [
                          "*"
                        ],
                        "destinationAddresses": [
                          "*"
                        ],
                        "destinationPorts": [
                          "*"
                        ]
                      }
                    ]
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/firewallPolicies', format('policy-{0}', parameters('firewallName')))]"
              ]
            },
            {
              "type": "Microsoft.Network/azureFirewalls",
              "apiVersion": "2023-04-01",
              "name": "[parameters('firewallName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "AZFW_VNet",
                  "tier": "Standard"
                },
                "ipConfigurations": [
                  {
                    "name": "configuration",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('firewallSubnetId')]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('pip-{0}', parameters('firewallName')))]"
                      }
                    }
                  }
                ],
                "firewallPolicy": {
                  "id": "[resourceId('Microsoft.Network/firewallPolicies', format('policy-{0}', parameters('firewallName')))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/firewallPolicies', format('policy-{0}', parameters('firewallName')))]",
                "[resourceId('Microsoft.Network/publicIPAddresses', format('pip-{0}', parameters('firewallName')))]"
              ]
            }
          ],
          "outputs": {
            "privateIp": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/azureFirewalls', parameters('firewallName')), '2023-04-01').ipConfigurations[0].properties.privateIPAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-routetable",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "routeTableName": {
            "value": "rt-spokes"
          },
          "nextHopIpAddress": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-firewall'), '2025-04-01').outputs.privateIp.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7033800470662747749"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "routeTableName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Route Table."
              }
            },
            "nextHopIpAddress": {
              "type": "string",
              "metadata": {
                "description": "Next hop IP address (Firewall Private IP)."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/routeTables",
              "apiVersion": "2023-04-01",
              "name": "[parameters('routeTableName')]",
              "location": "[parameters('location')]",
              "properties": {
                "disableBgpRoutePropagation": false,
                "routes": [
                  {
                    "name": "to-firewall",
                    "properties": {
                      "addressPrefix": "0.0.0.0/0",
                      "nextHopType": "VirtualAppliance",
                      "nextHopIpAddress": "[parameters('nextHopIpAddress')]"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "routeTableId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/routeTables', parameters('routeTableName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-firewall')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-spoke1-vnet",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetName": {
            "value": "vnet-spoke1"
          },
          "vnetAddressPrefix": {
            "value": "10.1.0.0/16"
          },
          "subnets": {
            "value": [
              {
                "name": "WorkloadSubnet",
                "addressPrefix": "10.1.1.0/24",
                "routeTableId": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-routetable'), '2025-04-01').outputs.routeTableId.value]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13426536082374555844"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Virtual Network."
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Address space for the Virtual Network."
              }
            },
            "subnets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "List of subnets to create."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for the resources, e.g. CostCenter, Env."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-04-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "copy": [
                  {
                    "name": "subnets",
                    "count": "[length(parameters('subnets'))]",
                    "input": {
                      "name": "[parameters('subnets')[copyIndex('subnets')].name]",
                      "properties": {
                        "addressPrefix": "[parameters('subnets')[copyIndex('subnets')].addressPrefix]",
                        "networkSecurityGroup": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'nsgId'), createObject('id', parameters('subnets')[copyIndex('subnets')].nsgId), null())]",
                        "routeTable": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'routeTableId'), createObject('id', parameters('subnets')[copyIndex('subnets')].routeTableId), null())]",
                        "privateEndpointNetworkPolicies": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'privateEndpointNetworkPolicies'), parameters('subnets')[copyIndex('subnets')].privateEndpointNetworkPolicies, 'Enabled')]",
                        "privateLinkServiceNetworkPolicies": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'privateLinkServiceNetworkPolicies'), parameters('subnets')[copyIndex('subnets')].privateLinkServiceNetworkPolicies, 'Enabled')]"
                      }
                    }
                  }
                ],
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                }
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[parameters('vnetName')]"
            },
            "subnets": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('subnets'))]",
                "input": {
                  "name": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[copyIndex()].name]",
                  "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[copyIndex()].id]",
                  "addressPrefix": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[copyIndex()].properties.addressPrefix]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-routetable')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-spoke2-vnet",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetName": {
            "value": "vnet-spoke2"
          },
          "vnetAddressPrefix": {
            "value": "10.2.0.0/16"
          },
          "subnets": {
            "value": [
              {
                "name": "WorkloadSubnet",
                "addressPrefix": "10.2.1.0/24",
                "routeTableId": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-routetable'), '2025-04-01').outputs.routeTableId.value]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13426536082374555844"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Virtual Network."
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Address space for the Virtual Network."
              }
            },
            "subnets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "List of subnets to create."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for the resources, e.g. CostCenter, Env."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-04-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "copy": [
                  {
                    "name": "subnets",
                    "count": "[length(parameters('subnets'))]",
                    "input": {
                      "name": "[parameters('subnets')[copyIndex('subnets')].name]",
                      "properties": {
                        "addressPrefix": "[parameters('subnets')[copyIndex('subnets')].addressPrefix]",
                        "networkSecurityGroup": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'nsgId'), createObject('id', parameters('subnets')[copyIndex('subnets')].nsgId), null())]",
                        "routeTable": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'routeTableId'), createObject('id', parameters('subnets')[copyIndex('subnets')].routeTableId), null())]",
                        "privateEndpointNetworkPolicies": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'privateEndpointNetworkPolicies'), parameters('subnets')[copyIndex('subnets')].privateEndpointNetworkPolicies, 'Enabled')]",
                        "privateLinkServiceNetworkPolicies": "[if(contains(parameters('subnets')[copyIndex('subnets')], 'privateLinkServiceNetworkPolicies'), parameters('subnets')[copyIndex('subnets')].privateLinkServiceNetworkPolicies, 'Enabled')]"
                      }
                    }
                  }
                ],
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                }
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[parameters('vnetName')]"
            },
            "subnets": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('subnets'))]",
                "input": {
                  "name": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[copyIndex()].name]",
                  "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[copyIndex()].id]",
                  "addressPrefix": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[copyIndex()].properties.addressPrefix]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-routetable')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-hub-to-spoke1",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "peeringName": {
            "value": "hub-to-spoke1"
          },
          "localVnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet'), '2025-04-01').outputs.vnetId.value]"
          },
          "remoteVnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-spoke1-vnet'), '2025-04-01').outputs.vnetId.value]"
          },
          "allowGatewayTransit": {
            "value": true
          },
          "useRemoteGateways": {
            "value": false
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10269756001649553689"
            }
          },
          "parameters": {
            "peeringName": {
              "type": "string",
              "metadata": {
                "description": "Name of the peering resource."
              }
            },
            "localVnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the local VNet."
              }
            },
            "remoteVnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the remote VNet."
              }
            },
            "allowGatewayTransit": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow Gateway Transit. Set to true on Hub side."
              }
            },
            "useRemoteGateways": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Use Remote Gateways. Set to true on Spoke side."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', last(split(parameters('localVnetId'), '/')), parameters('peeringName'))]",
              "properties": {
                "remoteVirtualNetwork": {
                  "id": "[parameters('remoteVnetId')]"
                },
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                "useRemoteGateways": "[parameters('useRemoteGateways')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-spoke1-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-spoke1-to-hub",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "peeringName": {
            "value": "spoke1-to-hub"
          },
          "localVnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-spoke1-vnet'), '2025-04-01').outputs.vnetId.value]"
          },
          "remoteVnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet'), '2025-04-01').outputs.vnetId.value]"
          },
          "allowGatewayTransit": {
            "value": false
          },
          "useRemoteGateways": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10269756001649553689"
            }
          },
          "parameters": {
            "peeringName": {
              "type": "string",
              "metadata": {
                "description": "Name of the peering resource."
              }
            },
            "localVnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the local VNet."
              }
            },
            "remoteVnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the remote VNet."
              }
            },
            "allowGatewayTransit": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow Gateway Transit. Set to true on Hub side."
              }
            },
            "useRemoteGateways": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Use Remote Gateways. Set to true on Spoke side."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', last(split(parameters('localVnetId'), '/')), parameters('peeringName'))]",
              "properties": {
                "remoteVirtualNetwork": {
                  "id": "[parameters('remoteVnetId')]"
                },
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                "useRemoteGateways": "[parameters('useRemoteGateways')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-spoke1-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-hub-to-spoke2",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "peeringName": {
            "value": "hub-to-spoke2"
          },
          "localVnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet'), '2025-04-01').outputs.vnetId.value]"
          },
          "remoteVnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-spoke2-vnet'), '2025-04-01').outputs.vnetId.value]"
          },
          "allowGatewayTransit": {
            "value": true
          },
          "useRemoteGateways": {
            "value": false
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10269756001649553689"
            }
          },
          "parameters": {
            "peeringName": {
              "type": "string",
              "metadata": {
                "description": "Name of the peering resource."
              }
            },
            "localVnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the local VNet."
              }
            },
            "remoteVnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the remote VNet."
              }
            },
            "allowGatewayTransit": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow Gateway Transit. Set to true on Hub side."
              }
            },
            "useRemoteGateways": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Use Remote Gateways. Set to true on Spoke side."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', last(split(parameters('localVnetId'), '/')), parameters('peeringName'))]",
              "properties": {
                "remoteVirtualNetwork": {
                  "id": "[parameters('remoteVnetId')]"
                },
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                "useRemoteGateways": "[parameters('useRemoteGateways')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-spoke2-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-spoke2-to-hub",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "peeringName": {
            "value": "spoke2-to-hub"
          },
          "localVnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-spoke2-vnet'), '2025-04-01').outputs.vnetId.value]"
          },
          "remoteVnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet'), '2025-04-01').outputs.vnetId.value]"
          },
          "allowGatewayTransit": {
            "value": false
          },
          "useRemoteGateways": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10269756001649553689"
            }
          },
          "parameters": {
            "peeringName": {
              "type": "string",
              "metadata": {
                "description": "Name of the peering resource."
              }
            },
            "localVnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the local VNet."
              }
            },
            "remoteVnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the remote VNet."
              }
            },
            "allowGatewayTransit": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow Gateway Transit. Set to true on Hub side."
              }
            },
            "useRemoteGateways": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Use Remote Gateways. Set to true on Spoke side."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', last(split(parameters('localVnetId'), '/')), parameters('peeringName'))]",
              "properties": {
                "remoteVirtualNetwork": {
                  "id": "[parameters('remoteVnetId')]"
                },
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                "useRemoteGateways": "[parameters('useRemoteGateways')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-spoke2-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-vpngateway",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "gatewayName": {
            "value": "vpn-hub"
          },
          "gatewaySubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet'), '2025-04-01').outputs.subnets.value[0].id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6699658700752727557"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "gatewayName": {
              "type": "string",
              "metadata": {
                "description": "Name of the VPN Gateway."
              }
            },
            "gatewaySubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the GatewaySubnet. Must be named exactly \"GatewaySubnet\"."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-04-01",
              "name": "[format('pip-{0}', parameters('gatewayName'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworkGateways",
              "apiVersion": "2023-04-01",
              "name": "[parameters('gatewayName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "VpnGw1",
                  "tier": "VpnGw1"
                },
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "enableBgp": false,
                "ipConfigurations": [
                  {
                    "name": "default",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('gatewaySubnetId')]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('pip-{0}', parameters('gatewayName')))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', format('pip-{0}', parameters('gatewayName')))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-privatedns",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "zoneName": {
            "value": "internal.corp"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet'), '2025-04-01').outputs.vnetId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7777773517108011699"
            }
          },
          "parameters": {
            "zoneName": {
              "type": "string",
              "defaultValue": "privatelink.database.windows.net",
              "metadata": {
                "description": "Name of the Private DNS Zone."
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the VNet to link to."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[parameters('zoneName')]",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('zoneName'), format('{0}-link', last(split(parameters('vnetId'), '/'))))]",
              "location": "global",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-networkwatcher",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10139144541174036624"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkWatchers",
              "apiVersion": "2023-04-01",
              "name": "[format('NetworkWatcher_{0}', parameters('location'))]",
              "location": "[parameters('location')]",
              "properties": {}
            }
          ]
        }
      }
    }
  ],
  "outputs": {
    "hubVnetId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hub-vnet'), '2025-04-01').outputs.vnetId.value]"
    },
    "spoke1VnetId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-spoke1-vnet'), '2025-04-01').outputs.vnetId.value]"
    },
    "spoke2VnetId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-spoke2-vnet'), '2025-04-01').outputs.vnetId.value]"
    }
  }
}